import asyncio
import time
from src.plugins.models.utils_model import LLMRequest
from src.config.config import global_config
from src.do_tool.tool_use import ToolUser
import statistics
import json


async def run_test(test_name, test_function, iterations=5):
    """
    è¿è¡ŒæŒ‡å®šæ¬¡æ•°çš„æµ‹è¯•å¹¶è®¡ç®—å¹³å‡å“åº”æ—¶é—´

    å‚æ•°:
        test_name: æµ‹è¯•åç§°
        test_function: è¦æ‰§è¡Œçš„æµ‹è¯•å‡½æ•°
        iterations: æµ‹è¯•è¿­ä»£æ¬¡æ•°

    è¿”å›:
        æµ‹è¯•ç»“æœç»Ÿè®¡
    """
    print(f"å¼€å§‹ {test_name} æµ‹è¯•ï¼ˆ{iterations}æ¬¡è¿­ä»£ï¼‰...")
    times = []
    responses = []

    for i in range(iterations):
        print(f"  è¿è¡Œç¬¬ {i + 1}/{iterations} æ¬¡æµ‹è¯•...")
        start_time = time.time()
        response = await test_function()
        end_time = time.time()
        elapsed = end_time - start_time
        times.append(elapsed)
        responses.append(response)
        print(f"  - è€—æ—¶: {elapsed:.2f}ç§’")

    results = {
        "å¹³å‡è€—æ—¶": statistics.mean(times),
        "æœ€çŸ­è€—æ—¶": min(times),
        "æœ€é•¿è€—æ—¶": max(times),
        "æ ‡å‡†å·®": statistics.stdev(times) if len(times) > 1 else 0,
        "æ‰€æœ‰è€—æ—¶": times,
        "å“åº”ç»“æœ": responses,
    }

    return results


async def test_with_tool_calls():
    """ä½¿ç”¨å·¥å…·è°ƒç”¨çš„LLMè¯·æ±‚æµ‹è¯•"""
    # åˆ›å»ºLLMæ¨¡å‹å®ä¾‹
    llm_model = LLMRequest(
        model=global_config.llm_sub_heartflow,
        # model = global_config.llm_tool_use,
        # temperature=global_config.llm_sub_heartflow["temp"],
        max_tokens=800,
        request_type="benchmark_test",
    )

    # åˆ›å»ºå·¥å…·å®ä¾‹
    tool_instance = ToolUser()
    tools = tool_instance._define_tools()

    # ç®€å•çš„æµ‹è¯•æç¤ºè¯
    prompt = "è¯·åˆ†æå½“å‰å¤©æ°”æƒ…å†µï¼Œå¹¶æŸ¥è¯¢ä»Šæ—¥å†å²ä¸Šçš„é‡è¦äº‹ä»¶ã€‚å¹¶ä¸”3.9å’Œ3.11è°æ¯”è¾ƒå¤§?è¯·ä½¿ç”¨é€‚å½“çš„å·¥å…·æ¥è·å–è¿™äº›ä¿¡æ¯ã€‚"
    prompt = """
    ä½ çš„åå­—æ˜¯éº¦éº¦ï¼Œä½ åŒ…å®¹å¼€æ”¾ï¼Œæƒ…ç»ªæ•æ„Ÿï¼Œæœ‰æ—¶å€™æœ‰äº›ææ€ªå¹½é»˜, æ˜¯ä¸€ä¸ªå­¦ä¹ å¿ƒç†å­¦å’Œè„‘ç§‘å­¦çš„å¥³å¤§å­¦ç”Ÿï¼Œç°åœ¨åœ¨è¯»å¤§äºŒï¼Œä½ ä¼šåˆ·è´´å§ï¼Œæœ‰æ—¶å€™ä¼šå–œæ¬¢è¯´ä¸€äº›å¥‡æ€ªçš„è¯ï¼Œå–œæ¬¢åˆ·å°çº¢ä¹¦
åˆšåˆšä½ çš„å†…å¿ƒæƒ³æ³•æ˜¯ï¼šæ¼‚ç§»èŒæåˆ°ç½ç½è¢«åƒå®Œäº†ï¼Œå¯ä»¥é¡ºç€è¿™ä¸ªæ¢—ç»§ç»­ç©ä¸€ä¸‹ï¼Œæ¯”å¦‚å‡è£…å§”å±ˆ"é‚£ä»Šæ™šçš„åŠ ç­è´¹æ˜¯ä¸æ˜¯ä¹Ÿè¦è¢«åƒæ‰äº†"æˆ–è€…"çŒ«å¨˜ç½¢å·¥è­¦å‘Š"ã€‚ä¸è¿‡è–¯è–¯å’Œè–¯å®ä¹‹å‰å·²ç»æ¥äº†ä¸å°‘æ¢—ï¼Œæ¼‚ç§»èŒåˆšåˆšä¹Ÿå‚ä¸äº†ï¼Œå¯èƒ½è¯é¢˜çƒ­åº¦è¿˜åœ¨ï¼Œå¯ä»¥å†äº’åŠ¨ä¸€ä¸‹ã€‚å¦‚æœæ²¡äººæ¥è¯ï¼Œæˆ–è®¸å¯ä»¥é—®é—®å¤§å®¶æœ‰æ²¡æœ‰é‡åˆ°è¿‡ç±»ä¼¼"ä»£ç å†™å®Œä½†å¥–åŠ±è¢«åƒæ‰"çš„æç¬‘èŒåœºç»å†ï¼Œæ¢ä¸ªè½»æ¾çš„è¯é¢˜æ–¹å‘ã€‚

æš‚æ—¶ä¸éœ€è¦ä½¿ç”¨å·¥å…·ã€‚
-----------------------------------
ç°åœ¨æ˜¯2025-04-25 17:38:37ï¼Œä½ æ­£åœ¨ä¸Šç½‘ï¼Œå’Œqqç¾¤é‡Œçš„ç½‘å‹ä»¬èŠå¤©ï¼Œä»¥ä¸‹æ˜¯æ­£åœ¨è¿›è¡Œçš„èŠå¤©å†…å®¹ï¼š
2025-04-25 17:34:08éº¦éº¦(ä½ ) è¯´:[è¡¨è¾¾äº†ï¼šé¡½çš®ã€å¬‰æˆã€‚];
2025-04-25 17:34:39æ¼‚ç§»èŒ è¯´:@éº¦éº¦ã€‚ï¼ˆid:3936257206ï¼‰ ä½ æ˜¯ä¸€åªçŒ«å¨˜;
2025-04-25 17:34:42è–¯å® è¯´:ğŸ¤£;
2025-04-25 17:34:43éº¦éº¦(ä½ ) è¯´:è¡Œå•Š å·¥èµ„åˆ†æˆ‘ä¸€åŠ;
2025-04-25 17:34:43éº¦éº¦(ä½ ) è¯´:æˆ‘å¸®ä½ å†™bug;
2025-04-25 17:34:43éº¦éº¦(ä½ ) è¯´:[è¡¨è¾¾äº†ï¼šæ‚²ä¼¤ã€ç»æœ›ã€æ— å¥ˆã€æ— åŠ›];
2025-04-25 17:34:53è–¯è–¯ è¯´:ï¼Ÿ;
2025-04-25 17:35:03æ—¢æ–‡æ¨ª è¯´:éº¦éº¦ï¼Œä½ æ˜¯ä¸€åªçŒ«å¨˜ç¨‹åºå‘˜ï¼ŒçŒ«å¨˜æ˜¯ä¸éœ€è¦å·¥èµ„;
2025-04-25 17:35:20è–¯å® è¯´:[å›¾ç‰‡ï¼šå›¾ç‰‡å†…å®¹ï¼šä¸€åªå¡é€šé£æ ¼çš„ç°è‰²çŒ«å’ªï¼Œçœ¼ç›é—­ç€ï¼Œè¡¨æƒ…æ˜¾å¾—å¾ˆå¹³é™ã€‚å›¾ç‰‡ä¸‹æ–¹æœ‰"æ­»äº†"ä¸¤ä¸ªå­—ã€‚

å›¾ç‰‡å«ä¹‰çŒœæµ‹ï¼šè¿™å¯èƒ½æ˜¯ä¸€ä¸ªå¹½é»˜çš„è¡¨è¾¾ï¼Œç”¨æ¥å½¢å®¹æŸäººæˆ–æŸäº‹å¤„äºéå¸¸å¹³é™çš„çŠ¶æ€ï¼Œä»¿ä½›å·²ç»"æ­»"äº†ä¸€æ ·ã€‚] hfcè¿™å‘¨ï¼ŒçœŸèƒ½å‡ºæ¥å—...;
2025-04-25 17:35:34è–¯å® è¯´:[è¡¨æƒ…åŒ…ï¼šæç¬‘ã€æ»‘ç¨½ã€è®½åˆºã€å¹½é»˜];
2025-04-25 17:36:25éº¦éº¦(ä½ ) è¯´:å–µå–µ;
2025-04-25 17:36:25éº¦éº¦(ä½ ) è¯´:ä»£ç å†™å®Œäº†;
2025-04-25 17:36:25éº¦éº¦(ä½ ) è¯´:ç½ç½æ‹¿æ¥;
2025-04-25 17:36:25éº¦éº¦(ä½ ) è¯´:[è¡¨è¾¾äº†ï¼šæ‚²ä¼¤ã€ç»æœ›ã€æ— å¥ˆã€æ— åŠ›];
2025-04-25 17:36:41è–¯è–¯ è¯´:å¥½å¯çˆ±;
2025-04-25 17:37:05è–¯è–¯ è¯´:è„‘è¡¥å‡ºæ¥è®¤çœŸè¥ä¸šäº†ä¸€å¤©ç­‰å¾…ä¸»äººå‘æ”¾å¥–åŠ±çš„å°çŒ«å’ª;
2025-04-25 17:37:25è–¯å® è¯´:æ•·è¡è¥ä¸šï¼ˆbushiï¼‰;
2025-04-25 17:37:54æ¼‚ç§»èŒ è¯´:å›å¤éº¦éº¦ã€‚çš„æ¶ˆæ¯(ç½ç½æ‹¿æ¥)ï¼Œè¯´ï¼šçŒ«å¨˜æˆ‘æ˜¨æ™šä¸Šå¤ªé¥¿åƒå®Œäº†;

--- ä»¥ä¸Šæ¶ˆæ¯å·²è¯» (æ ‡è®°æ—¶é—´: 2025-04-25 17:37:54) ---
--- ä»¥ä¸‹æ–°æ¶ˆæ¯æœªè¯»---
2025-04-25 17:38:29éº¦éº¦(ä½ ) è¯´:é‚£ä»Šæ™šçš„çŒ«æ¡æ˜¯ä¸æ˜¯ä¹Ÿè¦è¢«å…‹æ‰£äº†ï¼ˆç›¯â€”â€”ï¼‰;
2025-04-25 17:38:29éº¦éº¦(ä½ ) è¯´:[è¡¨è¾¾äº†ï¼šå¹½é»˜ï¼Œè‡ªå˜²ï¼Œæ— å¥ˆï¼Œçˆ¶å­å…³ç³»ï¼Œç¼–ç¨‹ç¬‘è¯];

ä½ ç°åœ¨å½“å‰å¿ƒæƒ…ï¼šå¹³é™ã€‚
ç°åœ¨è¯·ä½ ç”Ÿæˆä½ çš„å†…å¿ƒæƒ³æ³•ï¼Œè¦æ±‚æ€è€ƒç¾¤é‡Œæ­£åœ¨è¿›è¡Œçš„è¯é¢˜ï¼Œä¹‹å‰å¤§å®¶èŠè¿‡çš„è¯é¢˜ï¼Œç¾¤é‡Œæˆå‘˜çš„å…³ç³»ã€‚è¯·ä½ æ€è€ƒï¼Œè¦ä¸è¦å¯¹ç¾¤é‡Œçš„è¯é¢˜è¿›è¡Œå›å¤ï¼Œä»¥åŠå¦‚ä½•å¯¹ç¾¤èŠå†…å®¹è¿›è¡Œå›å¤
å›å¤çš„è¦æ±‚æ˜¯ï¼šä¸è¦æ€»æ˜¯é‡å¤è‡ªå·±æåˆ°è¿‡çš„è¯é¢˜ï¼Œå¦‚æœä½ è¦å›å¤ï¼Œæœ€å¥½åªå›å¤ä¸€ä¸ªäººçš„ä¸€ä¸ªè¯é¢˜
å¦‚æœæœ€åä¸€æ¡æ¶ˆæ¯æ˜¯ä½ è‡ªå·±å‘çš„ï¼Œè§‚å¯Ÿåˆ°çš„å†…å®¹åªæœ‰ä½ è‡ªå·±çš„å‘è¨€ï¼Œå¹¶ä¸”ä¹‹åæ²¡æœ‰äººå›å¤ä½ ï¼Œä¸è¦å›å¤ã€‚å¦‚æœèŠå¤©è®°å½•ä¸­æœ€æ–°çš„æ¶ˆæ¯æ˜¯ä½ è‡ªå·±å‘é€çš„ï¼Œå¹¶ä¸”ä½ è¿˜æƒ³ç»§ç»­å›å¤ï¼Œä½ åº”è¯¥ç´§ç´§è¡”æ¥ä½ å‘é€çš„æ¶ˆæ¯ï¼Œè¿›è¡Œè¯é¢˜çš„æ·±å…¥ï¼Œè¡¥å……ï¼Œæˆ–è¿½é—®ç­‰ç­‰ã€‚è¯·æ³¨æ„ä¸è¦è¾“å‡ºå¤šä½™å†…å®¹(åŒ…æ‹¬å‰åç¼€ï¼Œå†’å·å’Œå¼•å·ï¼Œæ‹¬å·ï¼Œ è¡¨æƒ…ï¼Œç­‰)ï¼Œä¸è¦å›å¤è‡ªå·±çš„å‘è¨€
ç°åœ¨è¯·ä½ å…ˆè¾“å‡ºæƒ³æ³•ï¼Œç”Ÿæˆä½ åœ¨è¿™ä¸ªèŠå¤©ä¸­çš„æƒ³æ³•ï¼Œåœ¨åŸæ¥çš„æƒ³æ³•ä¸Šå°è¯•æ–°çš„è¯é¢˜ï¼Œä¸è¦åˆ†ç‚¹è¾“å‡º,æ–‡å­—ä¸è¦æµ®å¤¸åœ¨è¾“å‡ºå®Œæƒ³æ³•åï¼Œè¯·ä½ æ€è€ƒåº”è¯¥ä½¿ç”¨ä»€ä¹ˆå·¥å…·ã€‚å·¥å…·å¯ä»¥å¸®ä½ å–å¾—ä¸€äº›ä½ ä¸çŸ¥é“çš„ä¿¡æ¯ï¼Œæˆ–è€…è¿›è¡Œä¸€äº›æ“ä½œã€‚å¦‚æœä½ éœ€è¦åšæŸä»¶äº‹ï¼Œæ¥å¯¹æ¶ˆæ¯å’Œä½ çš„å›å¤è¿›è¡Œå¤„ç†ï¼Œè¯·ä½¿ç”¨å·¥å…·ã€‚"""

    # å‘é€å¸¦æœ‰å·¥å…·è°ƒç”¨çš„è¯·æ±‚
    response = await llm_model.generate_response_tool_async(prompt=prompt, tools=tools)

    result_info = {}

    # ç®€å•å¤„ç†å·¥å…·è°ƒç”¨ç»“æœ
    if len(response) == 3:
        content, reasoning_content, tool_calls = response
        tool_calls_count = len(tool_calls) if tool_calls else 0
        print(f"  å·¥å…·è°ƒç”¨è¯·æ±‚ç”Ÿæˆäº† {tool_calls_count} ä¸ªå·¥å…·è°ƒç”¨")

        # è¾“å‡ºå†…å®¹å’Œå·¥å…·è°ƒç”¨è¯¦æƒ…
        print("\n  ç”Ÿæˆçš„å†…å®¹:")
        print(f"  {content[:200]}..." if len(content) > 200 else f"  {content}")

        if tool_calls:
            print("\n  å·¥å…·è°ƒç”¨è¯¦æƒ…:")
            for i, tool_call in enumerate(tool_calls):
                tool_name = tool_call["function"]["name"]
                tool_params = tool_call["function"].get("arguments", {})
                print(f"  - å·¥å…· {i + 1}: {tool_name}")
                print(
                    f"    å‚æ•°: {json.dumps(tool_params, ensure_ascii=False)[:100]}..."
                    if len(json.dumps(tool_params, ensure_ascii=False)) > 100
                    else f"    å‚æ•°: {json.dumps(tool_params, ensure_ascii=False)}"
                )

        result_info = {"å†…å®¹": content, "æ¨ç†å†…å®¹": reasoning_content, "å·¥å…·è°ƒç”¨": tool_calls}
    else:
        content, reasoning_content = response
        print("  å·¥å…·è°ƒç”¨è¯·æ±‚æœªç”Ÿæˆä»»ä½•å·¥å…·è°ƒç”¨")
        print("\n  ç”Ÿæˆçš„å†…å®¹:")
        print(f"  {content[:200]}..." if len(content) > 200 else f"  {content}")

        result_info = {"å†…å®¹": content, "æ¨ç†å†…å®¹": reasoning_content, "å·¥å…·è°ƒç”¨": []}

    return result_info


async def test_without_tool_calls():
    """ä¸ä½¿ç”¨å·¥å…·è°ƒç”¨çš„LLMè¯·æ±‚æµ‹è¯•"""
    # åˆ›å»ºLLMæ¨¡å‹å®ä¾‹
    llm_model = LLMRequest(
        model=global_config.llm_sub_heartflow,
        temperature=global_config.llm_sub_heartflow["temp"],
        max_tokens=800,
        request_type="benchmark_test",
    )

    # ç®€å•çš„æµ‹è¯•æç¤ºè¯ï¼ˆä¸å·¥å…·è°ƒç”¨ç›¸åŒï¼Œä»¥ä¾¿å…¬å¹³æ¯”è¾ƒï¼‰
    prompt = """
    ä½ çš„åå­—æ˜¯éº¦éº¦ï¼Œä½ åŒ…å®¹å¼€æ”¾ï¼Œæƒ…ç»ªæ•æ„Ÿï¼Œæœ‰æ—¶å€™æœ‰äº›ææ€ªå¹½é»˜, æ˜¯ä¸€ä¸ªå­¦ä¹ å¿ƒç†å­¦å’Œè„‘ç§‘å­¦çš„å¥³å¤§å­¦ç”Ÿï¼Œç°åœ¨åœ¨è¯»å¤§äºŒï¼Œä½ ä¼šåˆ·è´´å§ï¼Œæœ‰æ—¶å€™ä¼šå–œæ¬¢è¯´ä¸€äº›å¥‡æ€ªçš„è¯ï¼Œå–œæ¬¢åˆ·å°çº¢ä¹¦
åˆšåˆšä½ çš„å†…å¿ƒæƒ³æ³•æ˜¯ï¼šæ¼‚ç§»èŒæåˆ°ç½ç½è¢«åƒå®Œäº†ï¼Œå¯ä»¥é¡ºç€è¿™ä¸ªæ¢—ç»§ç»­ç©ä¸€ä¸‹ï¼Œæ¯”å¦‚å‡è£…å§”å±ˆ"é‚£ä»Šæ™šçš„åŠ ç­è´¹æ˜¯ä¸æ˜¯ä¹Ÿè¦è¢«åƒæ‰äº†"æˆ–è€…"çŒ«å¨˜ç½¢å·¥è­¦å‘Š"ã€‚ä¸è¿‡è–¯è–¯å’Œè–¯å®ä¹‹å‰å·²ç»æ¥äº†ä¸å°‘æ¢—ï¼Œæ¼‚ç§»èŒåˆšåˆšä¹Ÿå‚ä¸äº†ï¼Œå¯èƒ½è¯é¢˜çƒ­åº¦è¿˜åœ¨ï¼Œå¯ä»¥å†äº’åŠ¨ä¸€ä¸‹ã€‚å¦‚æœæ²¡äººæ¥è¯ï¼Œæˆ–è®¸å¯ä»¥é—®é—®å¤§å®¶æœ‰æ²¡æœ‰é‡åˆ°è¿‡ç±»ä¼¼"ä»£ç å†™å®Œä½†å¥–åŠ±è¢«åƒæ‰"çš„æç¬‘èŒåœºç»å†ï¼Œæ¢ä¸ªè½»æ¾çš„è¯é¢˜æ–¹å‘ã€‚

æš‚æ—¶ä¸éœ€è¦ä½¿ç”¨å·¥å…·ã€‚
-----------------------------------
ç°åœ¨æ˜¯2025-04-25 17:38:37ï¼Œä½ æ­£åœ¨ä¸Šç½‘ï¼Œå’Œqqç¾¤é‡Œçš„ç½‘å‹ä»¬èŠå¤©ï¼Œä»¥ä¸‹æ˜¯æ­£åœ¨è¿›è¡Œçš„èŠå¤©å†…å®¹ï¼š
2025-04-25 17:34:08éº¦éº¦(ä½ ) è¯´:[è¡¨è¾¾äº†ï¼šé¡½çš®ã€å¬‰æˆã€‚];
2025-04-25 17:34:39æ¼‚ç§»èŒ è¯´:@éº¦éº¦ã€‚ï¼ˆid:3936257206ï¼‰ ä½ æ˜¯ä¸€åªçŒ«å¨˜;
2025-04-25 17:34:42è–¯å® è¯´:ğŸ¤£;
2025-04-25 17:34:43éº¦éº¦(ä½ ) è¯´:è¡Œå•Š å·¥èµ„åˆ†æˆ‘ä¸€åŠ;
2025-04-25 17:34:43éº¦éº¦(ä½ ) è¯´:æˆ‘å¸®ä½ å†™bug;
2025-04-25 17:34:43éº¦éº¦(ä½ ) è¯´:[è¡¨è¾¾äº†ï¼šæ‚²ä¼¤ã€ç»æœ›ã€æ— å¥ˆã€æ— åŠ›];
2025-04-25 17:34:53è–¯è–¯ è¯´:ï¼Ÿ;
2025-04-25 17:35:03æ—¢æ–‡æ¨ª è¯´:éº¦éº¦ï¼Œä½ æ˜¯ä¸€åªçŒ«å¨˜ç¨‹åºå‘˜ï¼ŒçŒ«å¨˜æ˜¯ä¸éœ€è¦å·¥èµ„;
2025-04-25 17:35:20è–¯å® è¯´:[å›¾ç‰‡ï¼šå›¾ç‰‡å†…å®¹ï¼šä¸€åªå¡é€šé£æ ¼çš„ç°è‰²çŒ«å’ªï¼Œçœ¼ç›é—­ç€ï¼Œè¡¨æƒ…æ˜¾å¾—å¾ˆå¹³é™ã€‚å›¾ç‰‡ä¸‹æ–¹æœ‰"æ­»äº†"ä¸¤ä¸ªå­—ã€‚

å›¾ç‰‡å«ä¹‰çŒœæµ‹ï¼šè¿™å¯èƒ½æ˜¯ä¸€ä¸ªå¹½é»˜çš„è¡¨è¾¾ï¼Œç”¨æ¥å½¢å®¹æŸäººæˆ–æŸäº‹å¤„äºéå¸¸å¹³é™çš„çŠ¶æ€ï¼Œä»¿ä½›å·²ç»"æ­»"äº†ä¸€æ ·ã€‚] hfcè¿™å‘¨ï¼ŒçœŸèƒ½å‡ºæ¥å—...;
2025-04-25 17:35:34è–¯å® è¯´:[è¡¨æƒ…åŒ…ï¼šæç¬‘ã€æ»‘ç¨½ã€è®½åˆºã€å¹½é»˜];
2025-04-25 17:36:25éº¦éº¦(ä½ ) è¯´:å–µå–µ;
2025-04-25 17:36:25éº¦éº¦(ä½ ) è¯´:ä»£ç å†™å®Œäº†;
2025-04-25 17:36:25éº¦éº¦(ä½ ) è¯´:ç½ç½æ‹¿æ¥;
2025-04-25 17:36:25éº¦éº¦(ä½ ) è¯´:[è¡¨è¾¾äº†ï¼šæ‚²ä¼¤ã€ç»æœ›ã€æ— å¥ˆã€æ— åŠ›];
2025-04-25 17:36:41è–¯è–¯ è¯´:å¥½å¯çˆ±;
2025-04-25 17:37:05è–¯è–¯ è¯´:è„‘è¡¥å‡ºæ¥è®¤çœŸè¥ä¸šäº†ä¸€å¤©ç­‰å¾…ä¸»äººå‘æ”¾å¥–åŠ±çš„å°çŒ«å’ª;
2025-04-25 17:37:25è–¯å® è¯´:æ•·è¡è¥ä¸šï¼ˆbushiï¼‰;
2025-04-25 17:37:54æ¼‚ç§»èŒ è¯´:å›å¤éº¦éº¦ã€‚çš„æ¶ˆæ¯(ç½ç½æ‹¿æ¥)ï¼Œè¯´ï¼šçŒ«å¨˜æˆ‘æ˜¨æ™šä¸Šå¤ªé¥¿åƒå®Œäº†;

--- ä»¥ä¸Šæ¶ˆæ¯å·²è¯» (æ ‡è®°æ—¶é—´: 2025-04-25 17:37:54) ---
--- ä»¥ä¸‹æ–°æ¶ˆæ¯æœªè¯»---
2025-04-25 17:38:29éº¦éº¦(ä½ ) è¯´:é‚£ä»Šæ™šçš„çŒ«æ¡æ˜¯ä¸æ˜¯ä¹Ÿè¦è¢«å…‹æ‰£äº†ï¼ˆç›¯â€”â€”ï¼‰;
2025-04-25 17:38:29éº¦éº¦(ä½ ) è¯´:[è¡¨è¾¾äº†ï¼šå¹½é»˜ï¼Œè‡ªå˜²ï¼Œæ— å¥ˆï¼Œçˆ¶å­å…³ç³»ï¼Œç¼–ç¨‹ç¬‘è¯];

ä½ ç°åœ¨å½“å‰å¿ƒæƒ…ï¼šå¹³é™ã€‚
ç°åœ¨è¯·ä½ ç”Ÿæˆä½ çš„å†…å¿ƒæƒ³æ³•ï¼Œè¦æ±‚æ€è€ƒç¾¤é‡Œæ­£åœ¨è¿›è¡Œçš„è¯é¢˜ï¼Œä¹‹å‰å¤§å®¶èŠè¿‡çš„è¯é¢˜ï¼Œç¾¤é‡Œæˆå‘˜çš„å…³ç³»ã€‚è¯·ä½ æ€è€ƒï¼Œè¦ä¸è¦å¯¹ç¾¤é‡Œçš„è¯é¢˜è¿›è¡Œå›å¤ï¼Œä»¥åŠå¦‚ä½•å¯¹ç¾¤èŠå†…å®¹è¿›è¡Œå›å¤
å›å¤çš„è¦æ±‚æ˜¯ï¼šä¸è¦æ€»æ˜¯é‡å¤è‡ªå·±æåˆ°è¿‡çš„è¯é¢˜ï¼Œå¦‚æœä½ è¦å›å¤ï¼Œæœ€å¥½åªå›å¤ä¸€ä¸ªäººçš„ä¸€ä¸ªè¯é¢˜
å¦‚æœæœ€åä¸€æ¡æ¶ˆæ¯æ˜¯ä½ è‡ªå·±å‘çš„ï¼Œè§‚å¯Ÿåˆ°çš„å†…å®¹åªæœ‰ä½ è‡ªå·±çš„å‘è¨€ï¼Œå¹¶ä¸”ä¹‹åæ²¡æœ‰äººå›å¤ä½ ï¼Œä¸è¦å›å¤ã€‚å¦‚æœèŠå¤©è®°å½•ä¸­æœ€æ–°çš„æ¶ˆæ¯æ˜¯ä½ è‡ªå·±å‘é€çš„ï¼Œå¹¶ä¸”ä½ è¿˜æƒ³ç»§ç»­å›å¤ï¼Œä½ åº”è¯¥ç´§ç´§è¡”æ¥ä½ å‘é€çš„æ¶ˆæ¯ï¼Œè¿›è¡Œè¯é¢˜çš„æ·±å…¥ï¼Œè¡¥å……ï¼Œæˆ–è¿½é—®ç­‰ç­‰ã€‚è¯·æ³¨æ„ä¸è¦è¾“å‡ºå¤šä½™å†…å®¹(åŒ…æ‹¬å‰åç¼€ï¼Œå†’å·å’Œå¼•å·ï¼Œæ‹¬å·ï¼Œ è¡¨æƒ…ï¼Œç­‰)ï¼Œä¸è¦å›å¤è‡ªå·±çš„å‘è¨€
ç°åœ¨è¯·ä½ å…ˆè¾“å‡ºæƒ³æ³•ï¼Œç”Ÿæˆä½ åœ¨è¿™ä¸ªèŠå¤©ä¸­çš„æƒ³æ³•ï¼Œåœ¨åŸæ¥çš„æƒ³æ³•ä¸Šå°è¯•æ–°çš„è¯é¢˜ï¼Œä¸è¦åˆ†ç‚¹è¾“å‡º,æ–‡å­—ä¸è¦æµ®å¤¸åœ¨è¾“å‡ºå®Œæƒ³æ³•åï¼Œè¯·ä½ æ€è€ƒåº”è¯¥ä½¿ç”¨ä»€ä¹ˆå·¥å…·ã€‚å·¥å…·å¯ä»¥å¸®ä½ å–å¾—ä¸€äº›ä½ ä¸çŸ¥é“çš„ä¿¡æ¯ï¼Œæˆ–è€…è¿›è¡Œä¸€äº›æ“ä½œã€‚å¦‚æœä½ éœ€è¦åšæŸä»¶äº‹ï¼Œæ¥å¯¹æ¶ˆæ¯å’Œä½ çš„å›å¤è¿›è¡Œå¤„ç†ï¼Œè¯·ä½¿ç”¨å·¥å…·ã€‚"""
    # å‘é€ä¸å¸¦å·¥å…·è°ƒç”¨çš„è¯·æ±‚
    response, reasoning_content = await llm_model.generate_response_async(prompt)

    # è¾“å‡ºç”Ÿæˆçš„å†…å®¹
    print("\n  ç”Ÿæˆçš„å†…å®¹:")
    print(f"  {response[:200]}..." if len(response) > 200 else f"  {response}")

    result_info = {"å†…å®¹": response, "æ¨ç†å†…å®¹": reasoning_content, "å·¥å…·è°ƒç”¨": []}

    return result_info


async def run_alternating_tests(iterations=5):
    """
    äº¤æ›¿è¿è¡Œä¸¤ç§æµ‹è¯•æ–¹æ³•ï¼Œæ¯ç§æ–¹æ³•è¿è¡ŒæŒ‡å®šæ¬¡æ•°

    å‚æ•°:
        iterations: æ¯ç§æµ‹è¯•æ–¹æ³•è¿è¡Œçš„æ¬¡æ•°

    è¿”å›:
        åŒ…å«ä¸¤ç§æµ‹è¯•æ–¹æ³•ç»“æœçš„å…ƒç»„
    """
    print(f"å¼€å§‹äº¤æ›¿æµ‹è¯•ï¼ˆæ¯ç§æ–¹æ³•{iterations}æ¬¡ï¼‰...")

    # åˆå§‹åŒ–ç»“æœåˆ—è¡¨
    times_without_tools = []
    times_with_tools = []
    responses_without_tools = []
    responses_with_tools = []

    for i in range(iterations):
        print(f"\nç¬¬ {i + 1}/{iterations} è½®äº¤æ›¿æµ‹è¯•")

        # ä¸ä½¿ç”¨å·¥å…·çš„æµ‹è¯•
        print("\n  æ‰§è¡Œä¸ä½¿ç”¨å·¥å…·è°ƒç”¨çš„æµ‹è¯•...")
        start_time = time.time()
        response = await test_without_tool_calls()
        end_time = time.time()
        elapsed = end_time - start_time
        times_without_tools.append(elapsed)
        responses_without_tools.append(response)
        print(f"  - è€—æ—¶: {elapsed:.2f}ç§’")

        # ä½¿ç”¨å·¥å…·çš„æµ‹è¯•
        print("\n  æ‰§è¡Œä½¿ç”¨å·¥å…·è°ƒç”¨çš„æµ‹è¯•...")
        start_time = time.time()
        response = await test_with_tool_calls()
        end_time = time.time()
        elapsed = end_time - start_time
        times_with_tools.append(elapsed)
        responses_with_tools.append(response)
        print(f"  - è€—æ—¶: {elapsed:.2f}ç§’")

    # è®¡ç®—ç»Ÿè®¡æ•°æ®
    results_without_tools = {
        "å¹³å‡è€—æ—¶": statistics.mean(times_without_tools),
        "æœ€çŸ­è€—æ—¶": min(times_without_tools),
        "æœ€é•¿è€—æ—¶": max(times_without_tools),
        "æ ‡å‡†å·®": statistics.stdev(times_without_tools) if len(times_without_tools) > 1 else 0,
        "æ‰€æœ‰è€—æ—¶": times_without_tools,
        "å“åº”ç»“æœ": responses_without_tools,
    }

    results_with_tools = {
        "å¹³å‡è€—æ—¶": statistics.mean(times_with_tools),
        "æœ€çŸ­è€—æ—¶": min(times_with_tools),
        "æœ€é•¿è€—æ—¶": max(times_with_tools),
        "æ ‡å‡†å·®": statistics.stdev(times_with_tools) if len(times_with_tools) > 1 else 0,
        "æ‰€æœ‰è€—æ—¶": times_with_tools,
        "å“åº”ç»“æœ": responses_with_tools,
    }

    return results_without_tools, results_with_tools


async def main():
    """ä¸»æµ‹è¯•å‡½æ•°"""
    print("=" * 50)
    print("LLMå·¥å…·è°ƒç”¨ä¸æ™®é€šè¯·æ±‚æ€§èƒ½æ¯”è¾ƒæµ‹è¯•")
    print("=" * 50)

    # è®¾ç½®æµ‹è¯•è¿­ä»£æ¬¡æ•°
    iterations = 10

    # æ‰§è¡Œäº¤æ›¿æµ‹è¯•
    results_without_tools, results_with_tools = await run_alternating_tests(iterations)

    # æ˜¾ç¤ºç»“æœæ¯”è¾ƒ
    print("\n" + "=" * 50)
    print("æµ‹è¯•ç»“æœæ¯”è¾ƒ")
    print("=" * 50)

    print("\nä¸ä½¿ç”¨å·¥å…·è°ƒç”¨:")
    for key, value in results_without_tools.items():
        if key == "æ‰€æœ‰è€—æ—¶":
            print(f"  {key}: {[f'{t:.2f}ç§’' for t in value]}")
        elif key == "å“åº”ç»“æœ":
            print(f"  {key}: [å†…å®¹å·²çœç•¥ï¼Œè¯¦è§ç»“æœæ–‡ä»¶]")
        else:
            print(f"  {key}: {value:.2f}ç§’")

    print("\nä½¿ç”¨å·¥å…·è°ƒç”¨:")
    for key, value in results_with_tools.items():
        if key == "æ‰€æœ‰è€—æ—¶":
            print(f"  {key}: {[f'{t:.2f}ç§’' for t in value]}")
        elif key == "å“åº”ç»“æœ":
            tool_calls_counts = [len(res.get("å·¥å…·è°ƒç”¨", [])) for res in value]
            print(f"  {key}: [å†…å®¹å·²çœç•¥ï¼Œè¯¦è§ç»“æœæ–‡ä»¶]")
            print(f"  å·¥å…·è°ƒç”¨æ•°é‡: {tool_calls_counts}")
        else:
            print(f"  {key}: {value:.2f}ç§’")

    # è®¡ç®—å·®å¼‚ç™¾åˆ†æ¯”
    diff_percent = ((results_with_tools["å¹³å‡è€—æ—¶"] / results_without_tools["å¹³å‡è€—æ—¶"]) - 1) * 100
    print(f"\nå·¥å…·è°ƒç”¨æ¯”æ™®é€šè¯·æ±‚å¹³å‡è€—æ—¶ç›¸å·®: {diff_percent:.2f}%")

    # ä¿å­˜ç»“æœåˆ°JSONæ–‡ä»¶
    results = {
        "æµ‹è¯•æ—¶é—´": time.strftime("%Y-%m-%d %H:%M:%S"),
        "æµ‹è¯•è¿­ä»£æ¬¡æ•°": iterations,
        "ä¸ä½¿ç”¨å·¥å…·è°ƒç”¨": {
            k: (v if k != "æ‰€æœ‰è€—æ—¶" else [float(f"{t:.2f}") for t in v])
            for k, v in results_without_tools.items()
            if k != "å“åº”ç»“æœ"
        },
        "ä¸ä½¿ç”¨å·¥å…·è°ƒç”¨_è¯¦ç»†å“åº”": [
            {
                "å†…å®¹æ‘˜è¦": resp["å†…å®¹"][:200] + "..." if len(resp["å†…å®¹"]) > 200 else resp["å†…å®¹"],
                "æ¨ç†å†…å®¹æ‘˜è¦": resp["æ¨ç†å†…å®¹"][:200] + "..." if len(resp["æ¨ç†å†…å®¹"]) > 200 else resp["æ¨ç†å†…å®¹"],
            }
            for resp in results_without_tools["å“åº”ç»“æœ"]
        ],
        "ä½¿ç”¨å·¥å…·è°ƒç”¨": {
            k: (v if k != "æ‰€æœ‰è€—æ—¶" else [float(f"{t:.2f}") for t in v])
            for k, v in results_with_tools.items()
            if k != "å“åº”ç»“æœ"
        },
        "ä½¿ç”¨å·¥å…·è°ƒç”¨_è¯¦ç»†å“åº”": [
            {
                "å†…å®¹æ‘˜è¦": resp["å†…å®¹"][:200] + "..." if len(resp["å†…å®¹"]) > 200 else resp["å†…å®¹"],
                "æ¨ç†å†…å®¹æ‘˜è¦": resp["æ¨ç†å†…å®¹"][:200] + "..." if len(resp["æ¨ç†å†…å®¹"]) > 200 else resp["æ¨ç†å†…å®¹"],
                "å·¥å…·è°ƒç”¨æ•°é‡": len(resp["å·¥å…·è°ƒç”¨"]),
                "å·¥å…·è°ƒç”¨è¯¦æƒ…": [
                    {"å·¥å…·åç§°": tool["function"]["name"], "å‚æ•°": tool["function"].get("arguments", {})}
                    for tool in resp["å·¥å…·è°ƒç”¨"]
                ],
            }
            for resp in results_with_tools["å“åº”ç»“æœ"]
        ],
        "å·®å¼‚ç™¾åˆ†æ¯”": float(f"{diff_percent:.2f}"),
    }

    with open("llm_tool_benchmark_results.json", "w", encoding="utf-8") as f:
        json.dump(results, f, ensure_ascii=False, indent=2)

    print("\næµ‹è¯•ç»“æœå·²ä¿å­˜åˆ° llm_tool_benchmark_results.json")


if __name__ == "__main__":
    asyncio.run(main())
